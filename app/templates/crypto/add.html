{% extends 'app.html' %}

{% block header %}
<div class="header-bar mx-content">
    <a href="{{ url_for('home') }}">
        <svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 122.87 122.87">
            <path
                d="M18,18A61.45,61.45,0,1,1,0,61.44,61.28,61.28,0,0,1,18,18ZM77.38,39l6.53,6.54a4,4,0,0,1,0,5.63L73.6,61.44,83.91,71.75a4,4,0,0,1,0,5.63l-6.53,6.53a4,4,0,0,1-5.63,0L61.44,73.6,51.13,83.91a4,4,0,0,1-5.63,0L39,77.38a4,4,0,0,1,0-5.63L49.28,61.44,39,51.13a4,4,0,0,1,0-5.63L45.5,39a4,4,0,0,1,5.63,0L61.44,49.28,71.75,39a4,4,0,0,1,5.63,0ZM61.44,10.54a50.91,50.91,0,1,0,36,14.91,50.83,50.83,0,0,0-36-14.91Z" />
        </svg>
    </a>
    <H1>Ajouter une transaction</H1>
</div>
{% endblock %}

{% block content %}
<form method="post" action="{{ url_for('add_new_crypto') }}">
    <fieldset>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" id='csrf_token'/>
        <input type="hidden" name="crypto_name" id="crypto_name"/>
        <input type="hidden" name="unique_price" id="unique_price"/>

        <label for="cryptomonnaie">Cryptomonnaie</label>
        <div class="input-container">
            <!-- Icone -->
            <?xml version="1.0" encoding="utf-8"?><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="122.879px" height="119.799px"
                viewBox="0 0 122.879 119.799" enable-background="new 0 0 122.879 119.799" xml:space="preserve">
                <g>
                    <path
                        d="M49.988,0h0.016v0.007C63.803,0.011,76.298,5.608,85.34,14.652c9.027,9.031,14.619,21.515,14.628,35.303h0.007v0.033v0.04 h-0.007c-0.005,5.557-0.917,10.905-2.594,15.892c-0.281,0.837-0.575,1.641-0.877,2.409v0.007c-1.446,3.66-3.315,7.12-5.547,10.307 l29.082,26.139l0.018,0.016l0.157,0.146l0.011,0.011c1.642,1.563,2.536,3.656,2.649,5.78c0.11,2.1-0.543,4.248-1.979,5.971 l-0.011,0.016l-0.175,0.203l-0.035,0.035l-0.146,0.16l-0.016,0.021c-1.565,1.642-3.654,2.534-5.78,2.646 c-2.097,0.111-4.247-0.54-5.971-1.978l-0.015-0.011l-0.204-0.175l-0.029-0.024L78.761,90.865c-0.88,0.62-1.778,1.209-2.687,1.765 c-1.233,0.755-2.51,1.466-3.813,2.115c-6.699,3.342-14.269,5.222-22.272,5.222v0.007h-0.016v-0.007 c-13.799-0.004-26.296-5.601-35.338-14.645C5.605,76.291,0.016,63.805,0.007,50.021H0v-0.033v-0.016h0.007 c0.004-13.799,5.601-26.296,14.645-35.338C23.683,5.608,36.167,0.016,49.955,0.007V0H49.988L49.988,0z M50.004,11.21v0.007h-0.016 h-0.033V11.21c-10.686,0.007-20.372,4.35-27.384,11.359C15.56,29.578,11.213,39.274,11.21,49.973h0.007v0.016v0.033H11.21 c0.007,10.686,4.347,20.367,11.359,27.381c7.009,7.012,16.705,11.359,27.403,11.361v-0.007h0.016h0.033v0.007 c10.686-0.007,20.368-4.348,27.382-11.359c7.011-7.009,11.358-16.702,11.36-27.4h-0.006v-0.016v-0.033h0.006 c-0.006-10.686-4.35-20.372-11.358-27.384C70.396,15.56,60.703,11.213,50.004,11.21L50.004,11.21z" />
                </g>
            </svg>
            <!-- Select -->
            <select 
                name="cryptomonnaie" 
                aria-label="s√©lectionner une cryptomonnaie" 
                aria-required="true"
                role="listbox" 
                id="cryptomonnaie"
                required
            >
                <option value="">S√©lectionner une crypto</option>
                {% for cryptomonnaie in cryptomonnaies.data %}
                <option value="{{cryptomonnaie.id}}">
                    {{cryptomonnaie.name}}
                </option>
                {% endfor %}
            </select>
        </div>
        <small></small>
        <label for="quantity">Quantit√©</label>
        <div class="input-container">
            <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 100.75 100.75"
                style="enable-background:new 0 0 100.75 100.75;" xml:space="preserve">
                <path d="M93.328,70.679c-0.189-5.377-1.865-11.855-4.717-18.24c-2.852-6.391-6.557-11.965-10.433-15.695
                c-4.168-4.012-8.155-5.481-11.241-4.151c-0.025,0.01-0.051,0.014-0.076,0.025l-3.62,1.617v-8.492c0-0.012,0.002-0.024,0.002-0.036
                c0-6.717-11.59-11.782-26.96-11.782c-15.338,0-26.91,5.045-26.958,11.741c0,0.014-0.004,0.027-0.004,0.042v15.18
                c0,0.08,0.011,0.158,0.024,0.234c-0.013,0.077-0.024,0.154-0.024,0.234c0,0.137,0.012,0.271,0.022,0.406
                c-0.011,0.072-0.022,0.143-0.022,0.218v15.18c0,0.081,0.011,0.159,0.024,0.236c-0.013,0.077-0.024,0.155-0.024,0.236
                c0,0.171,0.013,0.34,0.027,0.508c-0.017,0.088-0.027,0.179-0.027,0.272v15.18c0,0.08,0.011,0.158,0.024,0.234
                c-0.013,0.077-0.024,0.154-0.024,0.234c0,6.716,11.592,11.78,26.964,11.78c9.765,0,18.664-2.228,23.348-5.75
                c4.192,5.442,8.702,8.65,12.479,8.65c0.861,0,1.686-0.166,2.458-0.511l14.235-6.359c0.014-0.006,0.029-0.01,0.043-0.016
                C91.943,80.473,93.534,76.504,93.328,70.679z M53.006,38.807l-0.432,0.19c-2.973,1.329-4.475,4.993-4.525,10.012
                c-3.59,0.785-7.614,1.218-11.763,1.218c-14.178,0-24.058-4.675-24.058-8.872c0-0.08-0.011-0.158-0.024-0.234
                c0.013-0.077,0.024-0.154,0.024-0.234v-9.693c4.368,3.803,13.28,6.295,24.056,6.295c10.773,0,19.682-2.49,24.052-6.292v4.336
                L53.006,38.807z M12.204,57.396c0.013-0.077,0.024-0.155,0.024-0.236V46.842c4.37,3.801,13.282,6.292,24.058,6.292
                c4.158,0,8.229-0.399,11.89-1.157c0.335,3.691,1.324,7.91,2.971,12.368c-4.408,1.427-9.395,2.158-14.861,2.158
                c-14.178,0-24.058-4.675-24.058-8.87C12.228,57.551,12.217,57.473,12.204,57.396z M36.284,16.831
                c14.163,0,24.035,4.669,24.053,8.865c0,0.004-0.001,0.007-0.001,0.011v0.027c-0.042,4.191-9.907,8.849-24.052,8.849
                c-14.176,0-24.054-4.678-24.054-8.876S22.108,16.831,36.284,16.831z M36.286,82.935c-14.178,0-24.058-4.677-24.058-8.874
                c0-0.08-0.011-0.158-0.024-0.234c0.013-0.077,0.024-0.154,0.024-0.234V63.118c4.37,3.801,13.282,6.291,24.058,6.291
                c5.842,0,11.188-0.799,15.929-2.358c0.191,0.455,0.388,0.912,0.593,1.37c1.554,3.478,3.301,6.603,5.138,9.316
                C53.85,80.874,45.386,82.935,36.286,82.935z M73.783,85.394l-0.411,0.189c-3.839,1.704-12.13-5.408-17.911-18.348
                c-5.775-12.944-5.531-23.873-1.707-25.582l9.301-4.153c-0.526,1.737-0.761,3.85-0.674,6.295c0.189,5.376,1.865,11.856,4.718,18.247
                c2.852,6.388,6.557,11.959,10.433,15.689c1.767,1.699,3.497,2.925,5.144,3.693L73.783,85.394z M87.669,79.198
                c-0.002,0.001-0.005,0.001-0.007,0.002l-0.01,0.004c-1.914,0.846-4.87-0.453-8.105-3.567c-3.613-3.477-7.092-8.726-9.794-14.78
                c-2.704-6.057-4.291-12.152-4.468-17.164c-0.158-4.498,0.85-7.566,2.766-8.42c0.387-0.172,0.814-0.257,1.278-0.257
                c1.84,0,4.246,1.331,6.834,3.821c3.613,3.477,7.091,8.728,9.794,14.786c2.704,6.052,4.29,12.146,4.467,17.158
                C90.583,75.273,89.578,78.34,87.669,79.198z" />
            </svg>
            <input 
                id="quantity" 
                type="number" 
                name="quantity" 
                aria-label="quantit√© de cryptomonnaie" 
                aria-required="true"
                role="textbox" 
                value="1"
                required
            />  
        </div>
        <small></small>
        <label for="euro_price">Prix d'achat</label>
        <div class="input-container">
            <?xml version="1.0" encoding="UTF-8"?>
            <svg width="18px" height="18px" viewBox="0 0 18 18" version="1.1" xmlns="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink">
                <g id="Icons" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                    <g id="Outlined" transform="translate(-307.000000, -289.000000)">
                        <g id="Action" transform="translate(100.000000, 100.000000)">
                            <g id="Outlined-/-Action-/-euro_symbol" transform="translate(204.000000, 186.000000)">
                                <g>
                                    <polygon id="Path" points="0 0 24 0 24 24 0 24"></polygon>
                                    <path
                                        d="M15,18.5 C12.49,18.5 10.32,17.08 9.24,15 L15,15 L15,13 L8.58,13 C8.53,12.67 8.5,12.34 8.5,12 C8.5,11.66 8.53,11.33 8.58,11 L15,11 L15,9 L9.24,9 C10.32,6.92 12.5,5.5 15,5.5 C16.61,5.5 18.09,6.09 19.23,7.07 L21,5.3 C19.41,3.87 17.3,3 15,3 C11.08,3 7.76,5.51 6.52,9 L3,9 L3,11 L6.06,11 C6.02,11.33 6,11.66 6,12 C6,12.34 6.02,12.67 6.06,13 L3,13 L3,15 L6.52,15 C7.76,18.49 11.08,21 15,21 C17.31,21 19.41,20.13 21,18.7 L19.22,16.93 C18.09,17.91 16.62,18.5 15,18.5 Z"
                                        id="üîπ-Icon-Color" fill="#EFEFEF"></path>
                                </g>
                            </g>
                        </g>
                    </g>
                </g>
            </svg>
            <input 
                type="number" 
                name="euro_price" 
                readonly="readonly"
                aria-label="prix en euros"
                aria-required="true"
                aria-readonly="true" 
                id="euro_price" 
                required
                />
        </div>
        <small></small>
        <button type="submit" aria-label="Ajouter cryptomonnaie" id="submit">Ajouter</button>
    </fieldset>
</form>
{% endblock %}

{% block script %}
<script src="{{ url_for('static',filename='javascript/validateForm.js') }}"></script>
<script>
    // D√©claration des variables javascript
const selectedCrypto = document.getElementById('cryptomonnaie');
const cryptoName = document.getElementById('crypto_name');
const quantity = document.getElementById('quantity');
const euroPriceHolder = document.getElementById('euro_price');
const cryptomonnaiesJson = {{ cryptomonnaies.data | tojson }};
const submitButton = document.getElementById('submit');
const uniquePrice = document.getElementById('unique_price');
const csrf_token = document.getElementById('csrf_token');

let crypto;

// Fonction de mise √† jour des prix en fonction de la crypto et quantit√©
const updatePrice = (crypto = null) => {
    showSuccess(quantity);
    if (crypto != null ) { 
        euroPriceHolder.value = parseFloat(crypto[0].quote.EUR.price * quantity.value);
        cryptoName.value = crypto[0].name;
        uniquePrice.value = crypto[0].quote.EUR.price;
    }
    else {
        0
    };
}

const checkCryptomonnaie = () => {
    let valid=false;
    const id = selectedCrypto.value;
    if(isEmpty(id) || !isNumber(id) ) {
        showError(selectedCrypto, 'Merci de choisir une cryptomonnaie');
    } else {
        showSuccess(selectedCrypto);
        valid=true;
    }
    return valid;
}

// V√©rification que la quantit√© soit bien renseign√©e
const checkQuantity = () => {
    let valid=false;
    const quantity_value = quantity.value;
    if(isEmpty(quantity_value) || !isNumber(quantity_value) || isNull(quantity_value)) {
        showError(quantity, 'Merci de renseigner un entier non null');
    } else {
        showSuccess(quantity);
        valid=true;
    }
    return valid;
}

const checkEuroPrice = () => {
    let valid=false;
    const euroPrice = parseFloat(euroPriceHolder.value);
    if( isEmpty(euroPrice)) {
        showError(euroPriceHolder, "Le prix n'est pas calcul√© correctement");
    } else {
        showSuccess(euroPriceHolder);
        valid=true;
    }
    return valid;
}


// Quand on choisis une cryptomonnaie, filtre la cryptomonnaie
selectedCrypto.addEventListener('change', (event) => {
    selectedCrypto.parentElement.classList.add('success');
    selectedCrypto.parentElement.classList.remove('error');
    let crypto_id = event.target.value;
    if (crypto_id != '') {
        crypto = cryptomonnaiesJson.filter(
            cryptomonnaie => cryptomonnaie.id == parseInt(crypto_id)
        );
        showSuccess(selectedCrypto);
        updatePrice(crypto);
    }
});

// Quand nous renseignons une quantit√©, mise √† jour du prix affich√©
quantity.addEventListener('input', () => updatePrice(crypto));

// Blocage de l'envoi du formulaire au clic pour v√©rification
submitButton.addEventListener('click',(event) => {
    csrf_token.value="{{ csrf_token() }}";
    checkCryptomonnaie() && checkQuantity() && checkEuroPrice() 
    ? true 
    : event.preventDefault();
});
</script>
{% endblock %}